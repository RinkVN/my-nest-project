<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App - Test API</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
        }

        .todo-item {
            margin-bottom: 10px;
        }

        .completed {
            text-decoration: line-through;
            color: gray;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="my-4">Todo App - Test API</h1>

        <!-- Form thêm mới Todo -->
        <div class="card mb-4">
            <div class="card-header">Add New Todo</div>
            <div class="card-body">
                <form id="add-todo-form">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description"></textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="completed">
                        <label class="form-check-label" for="completed">Completed</label>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Todo</button>
                </form>
            </div>
        </div>

        <!-- Form tìm kiếm và lọc -->
        <div class="card mb-4">
            <div class="card-header">Filter Todos</div>
            <div class="card-body">
                <form id="filter-todo-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="filter-title" class="form-label">Search by Title</label>
                            <input type="text" class="form-control" id="filter-title">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="filter-completed" class="form-label">Completed</label>
                            <select class="form-select" id="filter-completed">
                                <option value="">All</option>
                                <option value="true">Completed</option>
                                <option value="false">Not Completed</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-secondary w-100">Filter</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Danh sách Todos -->
        <div class="card">
            <div class="card-header">Todo List</div>
            <div class="card-body">
                <div id="todo-list"></div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and Custom Script -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3000/todos';

        // Load todos on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadTodos();
        });

        // Load todos with optional filters
        async function loadTodos(filters = {}) {
            try {
                const query = new URLSearchParams(filters).toString();
                const response = await fetch(`${API_URL}${query ? '?' + query : ''}`);
                if (!response.ok) throw new Error((await response.json()).message);
                const todos = await response.json();
                displayTodos(todos);
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Display todos in the UI
        function displayTodos(todos) {
            const todoList = document.getElementById('todo-list');
            todoList.innerHTML = todos.length ? '' : '<p>No todos found.</p>';
            todos.forEach(todo => {
                const todoItem = document.createElement('div');
                todoItem.className = 'todo-item d-flex justify-content-between align-items-center p-2 border rounded';
                todoItem.innerHTML = `
          <div>
            <h5 class="${todo.completed ? 'completed' : ''} mb-1">${todo.title}</h5>
            <p class="mb-0">${todo.description || 'No description'}</p>
            <small>Created: ${new Date(todo.createdAt).toLocaleString()}</small>
          </div>
          <div>
            <button class="btn btn-sm btn-warning me-2" onclick="toggleComplete(${todo.id}, ${!todo.completed})">
              ${todo.completed ? 'Unmark' : 'Complete'}
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteTodo(${todo.id})">Delete</button>
          </div>
        `;
                todoList.appendChild(todoItem);
            });
        }

        // Add new todo
        document.getElementById('add-todo-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const completed = document.getElementById('completed').checked;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, description, completed }),
                });
                if (!response.ok) throw new Error((await response.json()).message);
                loadTodos(); // Reload todos
                e.target.reset(); // Reset form
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // Filter todos
        document.getElementById('filter-todo-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('filter-title').value;
            const completed = document.getElementById('filter-completed').value;

            const filters = {};
            if (title) filters.title = title;
            if (completed) filters.completed = completed;
            loadTodos(filters);
        });

        // Toggle complete status
        async function toggleComplete(id, completed) {
            try {
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed }),
                });
                if (!response.ok) throw new Error((await response.json()).message);
                loadTodos(); // Reload todos
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Delete todo
        async function deleteTodo(id) {
            if (!confirm('Are you sure you want to delete this todo?')) return;
            try {
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'DELETE',
                });
                if (!response.ok) throw new Error((await response.json()).message);
                loadTodos(); // Reload todos
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
    </script>
</body>

</html>